name: check-whitespace

# Get the repo with the commits(+1) in the series.
# Process `git log --check` output to extract just the check errors.
# Add a comment to the pull request with the check errors.

on:
  push:
  pull_request:
    types: [opened, synchronize]

jobs:
  check-whitespace:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: git log --check
      id: check_out
      run: |
        problems=()
        commit=
        commitText=
        lastcommit=
        while read dash sha etc
        do
          case "${dash}" in
          "---")
            commit="${sha}"
            commitText="${sha} ${etc}"
            ;;
          "")
            ;;
          *)
            if test -n "${commit}"
            then
              problems+=("" "--- ${commitText}")
              echo " "
              echo "--- ${commitText}"
              lastcommit=${commit}
              commit=
            fi
            problems+=("${dash} ${sha} ${etc}")
            echo "${problems[-1]}"
            ;;
          esac
        done <<< $(git log --check --pretty=format:"---% h% s" 2e90cd05998d838be7e294218f3373a626bf7eb5..)
        # done <<< $(git log --check --pretty=format:"---% h% s" ${{github.event.pull_request.base.sha}}..)

        if test ${#problems[*]}
        then
          echo "A whitespace issue was found in one or more of the commits." >$GITHUB_STEP_SUMMARY
          echo "" >>$GITHUB_STEP_SUMMARY
          echo "Run \`git rebase --whitespace=fix ${lastcommit}\` and `git push --force` to correct the problem." >>$GITHUB_STEP_SUMMARY
          for i in "${problems[@]}"
          do
            echo "${i}" >>$GITHUB_STEP_SUMMARY
          done

          exit 2
        fi
